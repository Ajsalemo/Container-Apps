{
    "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
		"location": {
		  "type": "string",
		  "defaultValue": "canadacentral"
		},
		"environmentName": {
		  "type": "string",
		  "defaultValue": "[concat('ContainerAppEnv-', uniqueString(resourceGroup().id))]"
		},
		"workspaceName": {
		  "type": "string",
		  "defaultValue": "[concat('LAWorkspace-', uniqueString(resourceGroup().id))]"
		},
		"workspaceLocation": {
		  "type": "string",
		  "defaultValue": "canadacentral"
		},
		"redisCacheName": {
		  "type": "string",
		  "defaultValue": "[format('redisCache-{0}', uniqueString(resourceGroup().id))]",
		  "metadata": {
			"description": "Specify the name of the Azure Redis Cache to create."
		  }
		},
		"redisCacheSKU": {
		  "type": "string",
		  "defaultValue": "Basic",
		  "allowedValues": [
			"Basic",
			"Standard",
			"Premium"
		  ],
		  "metadata": {
			"description": "Specify the pricing tier of the new Azure Redis Cache."
		  }
		},
		"redisCacheFamily": {
		  "type": "string",
		  "defaultValue": "C",
		  "allowedValues": [
			"C",
			"P"
		  ],
		  "metadata": {
			"description": "Specify the family for the sku. C = Basic/Standard, P = Premium."
		  }
		},
		"redisCacheCapacity": {
		  "type": "int",
		  "defaultValue": 1,
		  "allowedValues": [
			0,
			1,
			2,
			3,
			4,
			5,
			6
		  ],
		  "metadata": {
			"description": "Specify the size of the new Azure Redis Cache instance. Valid values: for C (Basic/Standard) family (0, 1, 2, 3, 4, 5, 6), for P (Premium) family (1, 2, 3, 4)"
		  }
		},
		"enableNonSslPort": {
		  "type": "bool",
		  "defaultValue": false,
		  "metadata": {
			"description": "Specify a boolean value that indicates whether to allow access via non-SSL ports."
		  }
		},
		"containerimage1": {
		  "type": "string",
		  "defaultValue": "docker.io/gfakedocker/statefulappnodejs:latest"
		}
	},
    "variables": {
	  "APP_PORT": "5000"
	},
    "resources": [
		{
			"name": "statefulapparm",
			"type": "Microsoft.Web/containerApps",
			"apiVersion": "2021-03-01",
			"location": "[parameters('location')]",
			"properties": {
				"kubeEnvironmentId": "/subscriptions/b5287c7e-a578-4a96-95b8-6eb8d3014a46/resourceGroups/containerapps-rg/providers/Microsoft.Web/kubeEnvironments/fakecontainerappenv2",
				"configuration": {
					"ingress": {
						"external": true,
						"targetPort": "[variables('APP_PORT')]"
					},
					"secrets": [
						{
							"name": "redishostsecret",
							"value": "redisCache-sk4asi34lsgdw.redis.cache.windows.net:6380"
						},
						{
							"name": "redispasswordsecret",
							"value": "ezuboukQzrom8j1dFSmCTXgDGhkVvu9yVAzCaBTFtPU="
						}
					]
				},
				"template": {
					"containers": [
						{
							"name": "statefulapp",
							"image": "[parameters('containerimage1')]",
							"env": [
								{
								  "name": "APP_PORT",
								  "value": "[variables('APP_PORT')]"
								}
							]
						}
					],
					"dapr": {
						"enabled": true,
						"appPort": "[variables('APP_PORT')]",
						"appId": "statefulapp",
						"components": [
							{
							  "name": "mystatestore",
							  "type": "state.redis",
							  "version": "v1",
							  "metadata": [
								{
								  "name": "redisHost",
								  "value": "redisCache-sk4asi34lsgdw.redis.cache.windows.net:6380"
								},
								{
								  "name": "redisPassword",
								  "value": "ezuboukQzrom8j1dFSmCTXgDGhkVvu9yVAzCaBTFtPU="
								},
								{
								  "name": "enableTLS",
								  "value": "true"
								}
							  ]
							}
						]
					}
				}
			}
		}
	]
}